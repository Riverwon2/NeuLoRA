#!/usr/bin/env bash
# ============================================================
# NeuLoRA í”„ë¡œì íŠ¸ â€” ì›í´ë¦­ í™˜ê²½ ì…‹ì—… ìŠ¤í¬ë¦½íŠ¸
# ============================================================
# í´ë¼ìš°ë“œ ì›Œí¬ìŠ¤íŽ˜ì´ìŠ¤ê°€ ì´ˆê¸°í™”ë˜ê±°ë‚˜, ìƒˆ ë¨¸ì‹ ì—ì„œ ì²˜ìŒ ì„¸íŒ…í•  ë•Œ
# ì´ ìŠ¤í¬ë¦½íŠ¸ í•˜ë‚˜ë§Œ ì‹¤í–‰í•˜ë©´ ë©ë‹ˆë‹¤.
#
# ì‹¤í–‰ ë°©ë²•:
#   chmod +x setup.sh && ./setup.sh
#
# ì™„ë£Œ í›„:
#   source ~/NeuLoRA/venv/bin/activate
#   (ë°±ì—”ë“œ)   cd ~/NeuLoRA/LangGraph && uvicorn api:app --reload --port 8800
#   (í”„ë¡ íŠ¸)   cd ~/NeuLoRA/LangGraph/frontend && npm run dev
# ============================================================

set -e  # ì—ëŸ¬ ë°œìƒ ì‹œ ì¦‰ì‹œ ì¤‘ë‹¨

PROJECT_ROOT="$(cd "$(dirname "$0")" && pwd)"
echo "ðŸ“ í”„ë¡œì íŠ¸ ë£¨íŠ¸: $PROJECT_ROOT"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1. ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ì—…ë°ì´íŠ¸
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo ""
echo "ðŸ“¦ [1/6] ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ì—…ë°ì´íŠ¸..."
apt-get update -qq

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2. Python ê°€ìƒí™˜ê²½ ìƒì„± ë° íŒ¨í‚¤ì§€ ì„¤ì¹˜
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo ""
echo "ðŸ [2/6] Python ê°€ìƒí™˜ê²½ ì„¤ì •..."

if [ ! -d "$PROJECT_ROOT/venv" ]; then
    echo "  â†’ venv ìƒì„± ì¤‘..."
    python3 -m venv "$PROJECT_ROOT/venv"
else
    echo "  â†’ venv ì´ë¯¸ ì¡´ìž¬, ê±´ë„ˆëœ€"
fi

# venv í™œì„±í™”
source "$PROJECT_ROOT/venv/bin/activate"

echo "  â†’ pip ì—…ê·¸ë ˆì´ë“œ & íŒ¨í‚¤ì§€ ì„¤ì¹˜..."
pip install --upgrade pip -q
pip install -r "$PROJECT_ROOT/requirements.txt" -q
echo "  âœ… Python íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì™„ë£Œ"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3. nvm + Node.js ì„¤ì¹˜
#    - vite(í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ë„êµ¬)ì— Node 18+ í•„ìš”
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo ""
echo "ðŸŸ¢ [3/6] nvm + Node.js ì„¤ì¹˜..."

export NVM_DIR="$HOME/.nvm"

if [ ! -s "$NVM_DIR/nvm.sh" ]; then
    echo "  â†’ nvm ì„¤ì¹˜ ì¤‘..."
    curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash 2>/dev/null
else
    echo "  â†’ nvm ì´ë¯¸ ì„¤ì¹˜ë¨"
fi

# nvm ë¡œë“œ
[ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"

if ! command -v node &>/dev/null || [[ "$(node -v)" < "v18" ]]; then
    echo "  â†’ Node.js 20 LTS ì„¤ì¹˜ ì¤‘..."
    nvm install 20
    nvm use 20
    nvm alias default 20
else
    echo "  â†’ Node.js $(node -v) ì´ë¯¸ ì„¤ì¹˜ë¨"
fi

echo "  âœ… Node $(node -v), npm $(npm -v)"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 4. venv activateì— nvm ìžë™ ë¡œë“œ ì¶”ê°€
#    - activate í•  ë•Œ Nodeë„ ê°™ì´ ìž¡ížˆë„ë¡
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo ""
echo "ðŸ”— [4/6] venv activateì— nvm ìžë™ ë¡œë“œ ì—°ê²°..."

ACTIVATE_FILE="$PROJECT_ROOT/venv/bin/activate"
NVM_MARKER="# >>> nvm auto-load >>>"

if ! grep -q "$NVM_MARKER" "$ACTIVATE_FILE"; then
    cat >> "$ACTIVATE_FILE" << 'NVMEOF'

# >>> nvm auto-load >>>
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
# <<< nvm auto-load <<<
NVMEOF
    echo "  âœ… activate ìŠ¤í¬ë¦½íŠ¸ì— nvm ë¡œë“œ ì¶”ê°€ ì™„ë£Œ"
else
    echo "  â†’ ì´ë¯¸ ì¶”ê°€ë˜ì–´ ìžˆìŒ, ê±´ë„ˆëœ€"
fi

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 5. í”„ë¡ íŠ¸ì—”ë“œ npm íŒ¨í‚¤ì§€ ì„¤ì¹˜
#    - node_modulesë¥¼ í˜„ìž¬ Linux í™˜ê²½ì— ë§žê²Œ ìƒˆë¡œ ì„¤ì¹˜
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo ""
echo "ðŸŒ [5/6] í”„ë¡ íŠ¸ì—”ë“œ npm íŒ¨í‚¤ì§€ ì„¤ì¹˜..."

FRONTEND_DIR="$PROJECT_ROOT/LangGraph/frontend"

if [ -d "$FRONTEND_DIR" ]; then
    cd "$FRONTEND_DIR"
    # ë‹¤ë¥¸ OS(Windows ë“±)ì—ì„œ ë³µì‚¬ëœ node_modules ì¶©ëŒ ë°©ì§€
    rm -rf node_modules package-lock.json
    npm install --silent
    echo "  âœ… npm íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì™„ë£Œ"
    cd "$PROJECT_ROOT"
else
    echo "  âš ï¸ $FRONTEND_DIR ì—†ìŒ, ê±´ë„ˆëœ€"
fi

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 6. í™˜ê²½ ë³€ìˆ˜ í™•ì¸ (.env)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo ""
echo "ðŸ”‘ [6/6] .env í™˜ê²½ ë³€ìˆ˜ í™•ì¸..."

ENV_FILE="$PROJECT_ROOT/.env"
if [ -f "$ENV_FILE" ]; then
    echo "  âœ… .env íŒŒì¼ ì¡´ìž¬"
    # ì£¼ìš” í‚¤ ì„¤ì • ì—¬ë¶€ë§Œ í™•ì¸ (ê°’ì€ ì¶œë ¥í•˜ì§€ ì•ŠìŒ)
    for key in HF_API_KEY TAVILY_API_KEY LLM_MODE; do
        if grep -q "^${key}=" "$ENV_FILE"; then
            echo "    âœ“ $key ì„¤ì •ë¨"
        else
            echo "    âœ— $key ë¯¸ì„¤ì • â€” í™•ì¸ í•„ìš”!"
        fi
    done
else
    echo "  âš ï¸ .env íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤! ì•„ëž˜ í•­ëª©ì„ ì„¤ì •í•´ì£¼ì„¸ìš”:"
    echo "    HF_API_KEY=your_huggingface_token"
    echo "    TAVILY_API_KEY=your_tavily_key"
    echo "    LLM_MODE=vessel"
    echo "    LLM_4BIT=1"
fi

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ì™„ë£Œ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo ""
echo "============================================"
echo "ðŸŽ‰ ì…‹ì—… ì™„ë£Œ!"
echo "============================================"
echo ""
echo "ì‚¬ìš©ë²•:"
echo "  1. ê°€ìƒí™˜ê²½ í™œì„±í™”:"
echo "     source ~/NeuLoRA/venv/bin/activate"
echo ""
echo "  2. ë°±ì—”ë“œ ì‹¤í–‰:"
echo "     cd ~/NeuLoRA/LangGraph"
echo "     uvicorn api:app --reload --port 8800"
echo ""
echo "  3. í”„ë¡ íŠ¸ì—”ë“œ ì‹¤í–‰ (ë‹¤ë¥¸ í„°ë¯¸ë„):"
echo "     cd ~/NeuLoRA/LangGraph/frontend"
echo "     npm run dev"
echo ""
